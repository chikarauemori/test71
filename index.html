<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ユーザー登録</title>
     <script
      src="https://kit.fontawesome.com/d0a601627a.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://yubinbango.github.io/yubinbango/yubinbango.js"
      charset="UTF-8"
    ></script>
    <link
      href="https://use.fontawesome.com/releases/v5.6.1/css/all.css"
      rel="stylesheet"
    />
  </head>
  <body>
          <h1>
        <img
          src="https://i.ibb.co/Wv8X3LVh/1.png"
          alt="IMG-5451"
          width="100px"
          height="100px"
        />
        クールシェア宝塚2025<br />
        スタンプラリーカード
      </h1>

        <script>
            function getDistance(lat1,lon1,lat2,lon2){
                const R = 6371
                const dLat = (lat2-lat1) * Math.PI / 180;
                const dLon = (lon2-lon1) * Math.PI / 180;
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;        
            }

            let storeData = [];
            fetch ("https://api.sheety.co/ce9e3a0218bcaf86020ff53bb918a57e/マップ/シート1")
              .then(response => response.json())
              .then(data => {
                storeData = data.シート1.map(entry => ({
                name: entry.name,
                lat: parseFloat(entry.lat),
                lon: parseFloat(entry.lon)
              })); 
                console.log(storeData);
              });
              

        </script>
        
        <button onclick = "sortByDistance()">近い順に並び替える</button>
        <ul id = "store-list"></ul>

        <script>
            function sortByDistance(){
                navigator.geolocation.getCurrentPosition((position) => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;                    
                
                
                const sortedStores = storeData
                    .map(store => ({
                        ...store,
                        distance: getDistance(userLat, userLon, store.lat, store.lon)
                    }))
                    .sort((a, b) => a.distance - b.distance);

                const top10 = sortedStores.slice(0,10);
                displayStores(top10);
                  },

                (error) => {
                console.error("位置情報の取得に失敗しました:", error);
                }
            );
            }

            function displayStores(stores){
                const list = document.getElementById("store-list");
                list.innerHTML = "";
                stores.forEach(store => {
                    const li = document.createElement("li");
                    li.textContent = `${store.name}(${store.distance.toFixed(2)}km)`;
                    list.appendChild(li);
                });
            }

        </script>

              <style>
                #map {
                  height: 400px;
                  width: 100%;
                }
              </style>

              <h2>Google Maps テスト！</h2>
              <div id="map"></div>
          
              <script>
                let map;
                function initMap() {
                  const center = { lat: 34.810314, lng: 135.341766 }; // 東京駅
          
                  const map = new google.maps.Map(document.getElementById("map"), {
                    center: center,
                    zoom: 14,
                  });
                
                fetch ("https://api.sheety.co/ce9e3a0218bcaf86020ff53bb918a57e/マップ/シート1")
                .then(response => response.json())
                .then(data => {
                storeData = data.シート1.map(entry => ({
                  name: entry.name,
                  lat: parseFloat(entry.lat),
                  lon: parseFloat(entry.lon)
                })); 

                storeData.forEach(store => {
                  const marker = new google.maps.Marker({
                    position: { lat: store.lat, lng: store.lon},
                    map: map,
                    title: store.name
                  });

                const infoWindow = new google.maps.infoWindow({
                  content: `<strong>${store.name}</strong>`
                });

                marker.addListener("click",() => {
                  infoWindow.open(map, marker)
                });
              });
                });
              }
              
                
              </script>
                
              <!-- ↓ここに自分のAPIキーを入れる！ -->
              <script async defer
                src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBgMHwynQlm9iZrz3krFdn7XCFoAhJLA3o&callback=initMap">
              </script>
            </body>
          </html>
          

      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      <br>
      
